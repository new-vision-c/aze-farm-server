// =====================================================================================================
// PRISMA CLIENT CONFIGURATION
// =====================================================================================================
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

//* ========================================================================================================================================================================================================

// =====================================================================================================
// USERS MODEL
// =====================================================================================================
model users {
  user_id    String  @id @default(auto()) @map("_id") @db.ObjectId
  email      String  @unique
  password   String? // Optional for OAuth users
  fullname   String
  avatar_url String?
  is_active  Boolean @default(false)

  // --- Verification ---
  otp         Otp?
  is_verified Boolean @default(false)

  // --- Activity tracking ---
  email_verified_at    DateTime?
  last_login_at        DateTime?
  last_password_change DateTime?

  // --- Audit fields ---
  created_at DateTime  @default(now())
  updated_at DateTime  @updatedAt
  is_deleted Boolean   @default(false)
  deleted_at DateTime?

  // --- Role: USER / ADMIN ---
  role String @default("USER")

  // --- OAuth2.0 Integration ---
  oauth_accounts oauth_account[]

  // --- Indexes ---
  @@index([email, is_verified])
  @@index([email, deleted_at])
}

// =====================================================================================================
// OAUTH ACCOUNT MODEL (OAuth2.0 Provider Accounts)
// =====================================================================================================
model oauth_account {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // --- User relation ---
  user_id String @db.ObjectId
  user    users  @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  // --- Provider information ---
  provider         oauth_provider // GOOGLE, APPLE
  provider_user_id String // User ID from the OAuth provider
  provider_email   String? // Email from provider (may differ from user.email)

  // --- OAuth tokens ---
  access_token  String? // OAuth access token
  refresh_token String? // OAuth refresh token
  token_type    String? // Usually "Bearer"
  expires_at    DateTime? // Token expiration timestamp
  scope         String? // OAuth scopes granted

  // --- Provider profile data ---
  provider_profile_data Json? // Raw profile data from provider

  // --- Audit fields ---
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // --- Unique constraint: one account per provider per user ---
  // @@unique([provider, provider_user_id])
  // @@unique([user_id, provider])
}

// =====================================================================================================
// OAUTH PROVIDER ENUM
// =====================================================================================================
enum oauth_provider {
  GOOGLE
  APPLE
}

// =====================================================================================================
// BLACKLIST MODEL (Invalidated JWT Tokens)
// =====================================================================================================
model blacklist {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  token      String   @unique // JWT token to blacklist
  created_at DateTime @default(now())
  expire_at  DateTime // Expiration date of the token

  // --- Indexes ---
  @@index([token, expire_at])
  @@index([expire_at])
}

// =====================================================================================================
// TYPE: OTP (Used for email / phone verification)
// =====================================================================================================
type Otp {
  code      String
  expire_at DateTime
}

//* ========================================================================================================================================================================================================
